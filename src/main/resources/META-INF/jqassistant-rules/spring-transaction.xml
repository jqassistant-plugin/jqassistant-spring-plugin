<jqassistant-rules xmlns="http://schema.jqassistant.org/rule/v2.2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://schema.jqassistant.org/rule/v2.2 https://jqassistant.github.io/jqassistant/current/schema/jqassistant-rule-v2.2.xsd">

    <group id="spring-transaction:Default">
        <includeConstraint refId="spring-transaction:TransactionalMethodMustNotBeInvokedFromSameClass"/>
        <includeConstraint refId="spring-transaction:PrivateMethodMustNotBeAnnotatedWithTransactional"/>
    </group>

    <constraint id="spring-transaction:TransactionalMethodMustNotBeInvokedFromSameClass">
        <requiresConcept refId="spring-transaction:TransactionalMethod"/>
        <requiresConcept refId="java:GeneratedType"/>
        <description>Transactional methods must not be invoked from the same class.</description>
        <cypher><![CDATA[
            MATCH
              (artifact:Artifact)-[:CONTAINS]->(type:Type)-[:DECLARES]->(calledMethod:Method:Spring:Transactional),
              (type:Type)-[:DECLARES]->(callingMethod:Method),
              (callingMethod:Method)-[invokes:INVOKES]->(calledMethod)
            WHERE NOT (
              artifact:Test
              OR type:Generated
            )
            RETURN
              type as Type, callingMethod as Method, calledMethod as TransactionalMethod, invokes.lineNumber as LineNumber
        ]]></cypher>
        <report primaryColumn="callingMethod"/>
    </constraint>

    <constraint id="spring-transaction:PrivateMethodMustNotBeAnnotatedWithTransactional">
        <requiresConcept refId="java:GeneratedType"/>
        <description>Private methods must not be annotated with "org.springframework.transaction.annotation.Transactional",
            "jakarta.transaction.Transactional" or "javax.transaction.Transactional".</description>
        <cypher><![CDATA[
           MATCH
             (artifact:Artifact)-[:CONTAINS]->(type:Java:Type)-[:DECLARES]->(method:Java:Method {visibility: "private"}),
             (method:Method)-[:ANNOTATED_BY]->()-[:OF_TYPE]->(annotationType:Java:Type)
           WHERE
             annotationType.fqn in [
               "org.springframework.transaction.annotation.Transactional",
               "jakarta.transaction.Transactional",
               "javax.transaction.Transactional"
             ]
           AND NOT (
             artifact:Test
             OR type:Generated
           )
           RETURN
             type as Type, method as Method
        ]]></cypher>
        <report primaryColumn="method"/>
    </constraint>

    <concept id="spring-transaction:TransactionalMethod">
        <description>Provides transactional methods as ":Spring:Transactional:Method" and its configured transaction propagation semantics.</description>
        <cypher><![CDATA[
           MATCH
             (type:Type)-[:DECLARES]->(transactionalMethod:Spring:Transactional:Method)
           RETURN
             type as Type,
             transactionalMethod as TransactionalMethod,
             transactionalMethod.transactionPropagation as TransactionPropagation
           ORDER BY
             type.fqn, transactionalMethod.signature
        ]]></cypher>
    </concept>

    <concept id="spring-transaction:TransactionalMethodByAnnotatedMethod">
        <providesConcept refId="spring-transaction:TransactionalMethod" />
        <!-- Ensure that method-level-annotations override type-level annotations -->
        <requiresConcept refId="spring-transaction:TransactionalMethodByAnnotatedClass"/>
        <requiresConcept refId="java:MemberInheritedFrom"/>
        <description>
            Label all methods which are annotated with "@org.springframework.transaction.annotation.Transactional", "jakarta.transaction.Transactional",
            or "javax.transaction.Transactional", with "Spring" and "Transactional". It further identifies method level transaction propagation semantics. The configured transaction propagation at method level overrides the type level configuration.
        </description>
        <cypher><![CDATA[
           WITH
             [
               { annotationFqn: 'org.springframework.transaction.annotation.Transactional', propagationAttributeName: 'propagation' },
               { annotationFqn: 'jakarta.transaction.Transactional', propagationAttributeName: 'value' },
               { annotationFqn: 'javax.transaction.Transactional', propagationAttributeName: 'value'}
             ] as supportedAnnotationTypes
           UNWIND
             supportedAnnotationTypes AS supportedAnnotationType
           MATCH
             (type:Type)-[:DECLARES]->(transactionalMethod:Method),
             (transactionalMethod:Java:Method)-[:INHERITED_FROM*0..]->(definedMethod:Java:Method)-[:ANNOTATED_BY]->(annotation:Java:Annotation),
             (annotation)-[:OF_TYPE]->(annotationType:Type {fqn: supportedAnnotationType.annotationFqn})
           OPTIONAL MATCH
             (annotation)-[:HAS]->(propagation:Value {name: supportedAnnotationType.propagationAttributeName})-[:IS]->(propagationType:Java:Field)
           WITH
             type,
             transactionalMethod,
             COALESCE(SPLIT(propagationType.signature,' ')[1], 'REQUIRED') AS effectivePropagationType
           WHERE
             NOT definedMethod.visibility = "private"
           SET
             transactionalMethod:Spring:Transactional
           SET
             transactionalMethod.transactionPropagation = effectivePropagationType
           RETURN
             type as Type,
             transactionalMethod as TransactionalMethod,
             transactionalMethod.transactionPropagation AS TransactionPropagation
        ]]></cypher>
    </concept>

    <concept id="spring-transaction:TransactionalMethodByAnnotatedClass">
        <providesConcept refId="spring-transaction:TransactionalMethod" />
        <requiresConcept refId="java:MemberInheritedFrom"/>
        <description>
            Label methods of classes which are directly or indirectly annotated with "@org.springframework.transaction.annotation.Transactional", "jakarta.transaction.Transactional",
            or "javax.transaction.Transactional" with "Spring" and "Transactional". It further identifies type level transaction propagation semantics. The configured transaction propagation at type level applies to declared methods.
        </description>
        <cypher><![CDATA[
           WITH
             [
               { annotationFqn: 'org.springframework.transaction.annotation.Transactional', propagationAttributeName: 'propagation' },
               { annotationFqn: 'jakarta.transaction.Transactional', propagationAttributeName: 'value' },
               { annotationFqn: 'javax.transaction.Transactional', propagationAttributeName: 'value'}
             ] as supportedAnnotationTypes
           UNWIND
             supportedAnnotationTypes AS supportedAnnotationType
           MATCH
             (transactionalClass:Type)-[:EXTENDS|IMPLEMENTS*0..]->(:Type)-[:ANNOTATED_BY]->(annotation:Java:Annotation),
             (annotation)-[:OF_TYPE]->(annotationType:Type {fqn: supportedAnnotationType.annotationFqn}),
             (transactionalClass)-[:DECLARES]->(definedMethod:Java:Method)<-[:INHERITED_FROM*0..]-(transactionalMethod:Java:Method)
           OPTIONAL MATCH
             (annotation)-[:HAS]->(propagation:Value {name: supportedAnnotationType.propagationAttributeName})-[:IS]->(propagationType:Java:Field)
           WITH
             transactionalClass,
             transactionalMethod,
             COALESCE(SPLIT(propagationType.signature,' ')[1], 'REQUIRED') AS effectivePropagationType
           WHERE
             NOT (
               definedMethod:Constructor
               OR (definedMethod.static IS NOT NULL and transactionalMethod.static)
               OR definedMethod.visibility = "private"
             )
           SET
             transactionalMethod:Spring:Transactional
           SET
             transactionalMethod.transactionPropagation = effectivePropagationType
           RETURN
             transactionalClass as TransactionalClass,
             transactionalMethod AS TransactionalMethod,
             transactionalMethod.transactionPropagation AS TransactionPropagation
        ]]></cypher>
    </concept>

</jqassistant-rules>
